<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>🎶 Ranking Muzyk</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let isFirstTitle = true;
    setInterval(() => {
      document.title = isFirstTitle ? "🔧 | Made By Dorson" : "🎶 | Ranking Muzyk";
      isFirstTitle = !isFirstTitle;
    }, 5000);
  </script>
  <style>
    body {
      background-color: #0a0a0a;
      color: white;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    #particles-js { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .container { display: flex; justify-content: space-between; padding: 2rem; flex-wrap: nowrap; }
    .songs, .column { flex: 1; min-width: 250px; max-width: 30%; margin: 0 1rem; padding: 1rem; border: 2px dashed #444; border-radius: 10px; background-color: #111; }
    .column.drag-over { animation: pulse 0.5s infinite alternate; }
    @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.02); } }
    .column[data-score="10"] { border-color: #2bff00; box-shadow: 0 0 10px rgba(255, 255, 0, 0.3); }
    .column[data-score="5"] { border-color: #fffb00; box-shadow: 0 0 10px rgba(136, 136, 136, 0.3); }
    .column[data-score="0"] { border-color: #ff0000; box-shadow: 0 0 10px rgba(68, 68, 68, 0.3); }
    .song { background-color: #222; margin: 0.5rem 0; padding: 0.5rem; border-radius: 5px; cursor: grab; opacity: 0; animation: fadeIn 0.5s ease forwards; display: flex; justify-content: space-between; align-items: center; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .song:hover { background-color: #333; transform: scale(1.02); box-shadow: 0 2px 10px rgba(255, 255, 0, 0.2); }
    .song:active { transform: scale(0.98); }
    .song.dropped { animation: dropEffect 0.3s ease; }
    @keyframes dropEffect { 0% { transform: scale(1.1); } 100% { transform: scale(1); } }
    h2 { text-align: center; color: #fff; text-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
    .play-btn { color: #ffff00; cursor: pointer; }
    .play-btn:hover { color: #888; }
    #introScreen { position: fixed; top: 0; left: 0; z-index: 9999; width: 100vw; height: 100vh; background: linear-gradient(45deg, #0a0a0a, #1a1a1a, #0a0a0a); display: flex; justify-content: center; align-items: center; flex-direction: column; }
    #introScreen video { max-width: 80vw; height: auto; border-radius: 10px; box-shadow: 0 0 30px rgba(255, 255, 0, 0.3); }
    #introScreen button { margin-top: 20px; padding: 10px 20px; background: #222; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #introScreen button:hover { background: #333; transform: scale(1.1); }
    #downloadBtn, #resetBtn, #themeToggle { padding: 1rem 2rem; background: linear-gradient(45deg, #ffff00, #888); color: #000; border: none; border-radius: 10px; cursor: pointer; margin: 1rem; }
    #downloadBtn:hover, #resetBtn:hover, #themeToggle:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 255, 0, 0.5); }
    #notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ffff00; color: #000; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s ease; }
    #notification.show { opacity: 1; }
    #playerContainer { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #111; padding: 10px; border-radius: 10px; box-shadow: 0 0 15px rgba(255, 255, 0, 0.5); display: none; z-index: 1000; }
    #playerContainer iframe { border: none; border-radius: 5px; }
    #playerContainer .close-player { position: absolute; top: 5px; right: 5px; color: #ffff00; font-size: 1.2rem; cursor: pointer; }
    #modeSelectScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(45deg, #0a0a0a, #1a1a1a, #0a0a0a); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; }
    #modeSelectScreen h1 { color: #ffff00; text-shadow: 0 0 5px rgba(255, 255, 0, 0.5); }
    #modeSelectScreen button { margin: 10px; padding: 15px 30px; background: #222; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #modeSelectScreen button:hover { background: #333; transform: scale(1.1); }
    #duelsScreen { padding: 2rem; text-align: center; }
    #duelsSetup, #duelsGame, #lobbyScreen { background: #111; padding: 2rem; border-radius: 10px; box-shadow: 0 0 15px rgba(255, 255, 0, 0.3); }
    #duelsSetup input, #duelsGame input, #lobbyScreen input { padding: 0.5rem; margin: 0.5rem; background: #222; color: white; border: 1px solid #444; border-radius: 5px; }
    #duelsGame button, #lobbyScreen button { padding: 0.5rem 1rem; background: #ffff00; color: #000; border: none; border-radius: 5px; cursor: pointer; margin: 0.5rem; }
    #playerInputs { display: flex; justify-content: space-around; margin-top: 1rem; }
    #countdown { font-size: 2rem; color: #ffff00; margin: 1rem 0; }
    #duelNotification { margin-top: 1rem; color: #ffff00; }
    #lobbyPlayers { color: #ffff00; margin-top: 1rem; }
    #updatesScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #0a0a0a; padding: 2rem; display: none; z-index: 9999; overflow-y: auto; }
    #updatesScreen h1 { color: #ffff00; }
    #updatesScreen ul { list-style-type: none; padding: 0; }
    #updatesScreen li { margin: 1rem 0; }
    #updatesScreen button { padding: 0.5rem 1rem; background: #222; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #updatesScreen button:hover { background: #333; }
    .beta-notice { color: #ff0000; font-size: 0.9rem; margin-top: 5px; }
    footer { position: fixed; bottom: 0; width: 100%; text-align: center; padding: 10px; background: #0a0a0a; color: #888; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div id="particles-js"></div>

  <!-- Ekran wyboru trybu -->
  <div id="modeSelectScreen">
    <h1>Wybierz tryb gry</h1>
    <button onclick="startRanking()">Ranking</button>
    <button onclick="startDuels()">Duels <span class="beta-notice">(BETA - dużo błędów!)</span></button>
    <button onclick="showUpdates()">Aktualizacje</button>
  </div>

  <!-- Ekran Ranking -->
  <div id="rankingScreen" style="display: none;">
    <div id="introScreen">
      <video id="introVideo" src="wstep.mp4" autoplay controls playsinline></video>
      <button onclick="skipIntro()">Pomiń film</button>
    </div>
    <div id="mainContent" style="display: none;">
      <div class="container">
        <div class="songs" id="songList"><h2>🎵 Lista Utworów</h2></div>
        <div class="column" data-score="10"><h2>10/10</h2></div>
        <div class="column" data-score="5"><h2>5/10</h2></div>
        <div class="column" data-score="0"><h2>0/10</h2></div>
      </div>
      <button id="downloadBtn" onclick="downloadScreenshot()">📥 POBIERZ</button>
      <button id="resetBtn" onclick="resetRanking()">🔄 RESET</button>
      <button id="themeToggle" onclick="toggleTheme()">🌙 Tryb</button>
      <div id="notification"></div>
      <div id="playerContainer"><span class="close-player" onclick="closePlayer()">X</span></div>
    </div>
    <footer>© Copyright Dorian.S</footer>
  </div>

  <!-- Ekran Duels -->
  <div id="duelsScreen" style="display: none;">
    <div id="duelsSetup" style="display: none;">
      <h2>Tryb Duels (BETA)</h2>
      <p class="beta-notice">Wersja BETA - występuje dużo błędów!</p>
      <button onclick="createSession()">Stwórz nową sesję</button>
      <button onclick="joinSession()">Dołącz do sesji</button>
      <div id="sessionCode" style="display: none;">
        <p>Twój ID sesji: <span id="generatedCode"></span></p>
        <input type="text" id="playerName" placeholder="Twoja nazwa">
        <button onclick="showLobby()">Przejdź do lobby</button>
      </div>
      <div id="joinCode" style="display: none;">
        <input type="text" id="sessionInput" placeholder="Wprowadź ID sesji">
        <input type="text" id="joinPlayerName" placeholder="Twoja nazwa">
        <button onclick="joinLobby()">Dołącz do lobby</button>
      </div>
    </div>
    <div id="lobbyScreen" style="display: none;">
      <h2>Lobby</h2>
      <p>ID sesji: <span id="lobbyCode"></span></p>
      <div id="lobbyPlayers"></div>
      <button onclick="startDuelFromLobby()">Rozpocznij pojedynek</button>
      <button onclick="resetDuel()">Wyjdź z lobby</button>
    </div>
    <div id="duelsGame" style="display: none;">
      <h2 id="duelTitle"></h2>
      <div id="countdown"></div>
      <button id="playBtn" style="display: none;" onclick="playDuelSong()">Odtwórz</button>
      <div id="playerInputs">
        <div>
          <h3 id="player1Title"></h3>
          <input type="text" id="player1Artist" placeholder="Artysta">
          <button id="checkArtistBtn" onclick="checkArtist()">Sprawdź artystę</button>
          <input type="text" id="player1Title" placeholder="Tytuł" disabled>
          <button id="checkTitleBtn" onclick="checkTitle()" style="display: none;">Sprawdź tytuł</button>
        </div>
      </div>
      <button id="play7sBtn" style="display: none;" onclick="play7sDuelSong()">Odtwórz 7 sekund</button>
      <div id="duelNotification"></div>
      <button onclick="resetDuel()">Nowa gra</button>
    </div>
  </div>

  <!-- Ekran Aktualizacje -->
  <div id="updatesScreen">
    <h1>Aktualizacje</h1>
    <ul>
      <li><strong>9 kwietnia 2025, 12:00</strong> - Dodano tryb Duels w wersji BETA z PeerJS, dwuetapowe sprawdzanie odpowiedzi (artysta, potem tytuł), naprawiono synchronizację odtwarzania piosenek, dodano zakładkę Aktualizacje.</li>
      <!-- Tu możesz dodawać kolejne aktualizacje -->
    </ul>
    <button onclick="hideUpdates()">Wróć</button>
  </div>

  <audio id="dropSound" src="drop.mp3"></audio>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <script>
    particlesJS("particles-js", {
      "particles": {
        "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#ffff00" },
        "shape": { "type": "circle" },
        "opacity": { "value": 0.5, "random": true },
        "size": { "value": 3, "random": true },
        "line_linked": { "enable": true, "distance": 150, "color": "#888", "opacity": 0.4, "width": 1 },
        "move": { "enable": true, "speed": 2, "direction": "none", "random": false, "straight": false, "out_mode": "out" }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" } },
        "modes": { "repulse": { "distance": 100, "duration": 0.4 }, "push": { "particles_nb": 4 } }
      },
      "retina_detect": true
    });

    // Przełączanie trybów
    function startRanking() {
      document.getElementById("modeSelectScreen").style.display = "none";
      document.getElementById("rankingScreen").style.display = "block";
    }

    function startDuels() {
      document.getElementById("modeSelectScreen").style.display = "none";
      document.getElementById("duelsScreen").style.display = "block";
      document.getElementById("duelsSetup").style.display = "block";
    }

    function showUpdates() {
      document.getElementById("modeSelectScreen").style.display = "none";
      document.getElementById("updatesScreen").style.display = "block";
    }

    function hideUpdates() {
      document.getElementById("updatesScreen").style.display = "none";
      document.getElementById("modeSelectScreen").style.display = "flex";
    }

    function skipIntro() {
      const introScreen = document.getElementById('introScreen');
      const mainContent = document.getElementById('mainContent');
      introScreen.style.opacity = '0';
      setTimeout(() => {
        introScreen.style.display = 'none';
        mainContent.style.display = 'block';
        mainContent.style.opacity = '0';
        mainContent.style.transition = 'opacity 0.5s ease';
        setTimeout(() => mainContent.style.opacity = '1', 10);
      }, 300);
    }
    document.getElementById("introVideo").addEventListener("ended", skipIntro);

    function downloadScreenshot() {
      html2canvas(document.querySelector(".container")).then(canvas => {
        const link = document.createElement("a");
        link.download = "ranking.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }

    function resetRanking() {
      const songList = document.getElementById("songList");
      document.querySelectorAll(".column .song").forEach(song => songList.appendChild(song));
    }

    function toggleTheme() {
      document.body.classList.toggle("light-mode");
    }

    const songs = [
      { title: "DOMEK W GÓRACH – Wrzecion, Ola Kędra", videoId: "yxEuNBZ4pwM" },
      { title: "Sophia Loren – Tymek, Urbanski", videoId: "O-PjYv8Vgc0" }
    ];

    const songList = document.getElementById("songList");

    function createSongElement(title, index, videoId = null) {
      const div = document.createElement("div");
      div.className = "song";
      div.draggable = true;
      div.textContent = title;
      const playBtn = document.createElement("span");
      playBtn.className = "play-btn";
      playBtn.textContent = " ▶";
      playBtn.onclick = () => playSong(title, videoId);
      div.appendChild(playBtn);
      div.style.animationDelay = `${index * 0.05}s`;
      div.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", title);
        e.dataTransfer.effectAllowed = "move";
      });
      return div;
    }

    songs.forEach((song, index) => songList.appendChild(createSongElement(song.title, index, song.videoId)));

    document.querySelectorAll(".column").forEach(col => {
      col.addEventListener("dragover", e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        col.classList.add("drag-over");
      });
      col.addEventListener("dragleave", () => col.classList.remove("drag-over"));
      col.addEventListener("drop", e => {
        e.preventDefault();
        const title = e.dataTransfer.getData("text/plain");
        const songDiv = [...songList.children, ...document.querySelectorAll(".column .song")]
          .find(d => d.textContent.includes(title));
        if (songDiv) {
          songDiv.classList.add("dropped");
          col.appendChild(songDiv);
          document.getElementById("dropSound").play();
          col.classList.remove("drag-over");
          setTimeout(() => songDiv.classList.remove("dropped"), 300);
        }
      });
    });

    function playSong(title, videoId) {
      const playerContainer = document.getElementById("playerContainer");
      playerContainer.innerHTML = '<span class="close-player" onclick="closePlayer()">X</span>';
      const iframe = document.createElement("iframe");
      iframe.width = "560";
      iframe.height = "315";
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
      iframe.allow = "autoplay; encrypted-media";
      playerContainer.appendChild(iframe);
      playerContainer.style.display = "block";
    }

    function closePlayer() {
      const playerContainer = document.getElementById("playerContainer");
      playerContainer.style.display = "none";
      playerContainer.innerHTML = '<span class="close-player" onclick="closePlayer()">X</span>';
    }

    // Duels - konfiguracja z PeerJS
    let peer;
    let conn;
    let playerName = "";
    let isHost = false;
    let lobbyPlayers = [];
    let sessionId = "";
    let artistCorrect = false;

    function createSession() {
      peer = new Peer();
      peer.on('open', (id) => {
        sessionId = id;
        document.getElementById("sessionCode").style.display = "block";
        document.getElementById("joinCode").style.display = "none";
        document.getElementById("generatedCode").textContent = sessionId;
      });
      peer.on('connection', (connection) => {
        conn = connection;
        conn.on('open', () => {
          console.log("Połączenie z gościem nawiązane!");
        });
        conn.on('data', (data) => {
          if (data.type === 'join') {
            lobbyPlayers.push(data.name);
            updateLobbyPlayers();
            conn.send({ type: 'lobbyUpdate', players: lobbyPlayers });
          } else if (data.type === 'play') {
            playDuelSong();
          } else if (data.type === 'play7s') {
            play7sDuelSong();
          } else if (data.type === 'result') {
            showDuelNotification(data.message);
            disableInputs();
          }
        });
        conn.on('error', (err) => {
          console.error("Błąd połączenia:", err);
          showDuelNotification("Błąd połączenia z drugim graczem!");
        });
      });
      peer.on('error', (err) => {
        console.error("Błąd PeerJS:", err);
        showDuelNotification("Błąd PeerJS! Spróbuj ponownie.");
      });
    }

    function joinSession() {
      document.getElementById("sessionCode").style.display = "none";
      document.getElementById("joinCode").style.display = "block";
    }

    function showLobby() {
      playerName = document.getElementById("playerName").value.trim() || "Gracz 1";
      isHost = true;
      lobbyPlayers = [playerName];
      document.getElementById("duelsSetup").style.display = "none";
      document.getElementById("lobbyScreen").style.display = "block";
      document.getElementById("lobbyCode").textContent = sessionId;
      updateLobbyPlayers();
    }

    function joinLobby() {
      const inputId = document.getElementById("sessionInput").value.trim();
      playerName = document.getElementById("joinPlayerName").value.trim() || "Gracz 2";
      if (!inputId) {
        showDuelNotification("Wprowadź ID sesji!");
        return;
      }
      peer = new Peer();
      peer.on('open', () => {
        conn = peer.connect(inputId);
        conn.on('open', () => {
          conn.send({ type: 'join', name: playerName });
          document.getElementById("duelsSetup").style.display = "none";
          document.getElementById("lobbyScreen").style.display = "block";
          document.getElementById("lobbyCode").textContent = inputId;
          lobbyPlayers = [playerName];
          isHost = false;
          updateLobbyPlayers();
        });
        conn.on('data', (data) => {
          if (data.type === 'lobbyUpdate') {
            lobbyPlayers = data.players;
            updateLobbyPlayers();
          } else if (data.type === 'start') {
            startDuelFromLobby();
          } else if (data.type === 'play') {
            playDuelSong();
          } else if (data.type === 'play7s') {
            play7sDuelSong();
          } else if (data.type === 'result') {
            showDuelNotification(data.message);
            disableInputs();
          }
        });
        conn.on('error', (err) => {
          console.error("Błąd połączenia:", err);
          showDuelNotification("Nie udało się połączyć z gospodarzem!");
        });
      });
      peer.on('error', (err) => {
        console.error("Błąd PeerJS:", err);
        showDuelNotification("Błąd PeerJS! Sprawdź ID sesji.");
      });
    }

    function updateLobbyPlayers() {
      const lobbyPlayersEl = document.getElementById("lobbyPlayers");
      lobbyPlayersEl.innerHTML = "<h3>Gracze w lobby:</h3>";
      lobbyPlayers.forEach(player => {
        lobbyPlayersEl.innerHTML += `<p>${player}</p>`;
      });
    }

    function startDuelFromLobby() {
      if (lobbyPlayers.length < 2) {
        showDuelNotification("Czekaj na drugiego gracza!");
        return;
      }
      if (isHost && conn) {
        conn.send({ type: 'start' });
      }
      document.getElementById("lobbyScreen").style.display = "none";
      document.getElementById("duelsGame").style.display = "block";
      document.getElementById("duelTitle").textContent = `${lobbyPlayers[0]} vs ${lobbyPlayers[1]}`;
      document.getElementById("player1Title").textContent = isHost ? lobbyPlayers[0] : lobbyPlayers[1];
      document.getElementById("playBtn").style.display = "block";
      startTimer();
    }

    function startTimer() {
      let timeLeft = 15;
      const timer = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(timer);
          showDuelNotification("Czas minął! Możesz odtworzyć 7 sekund.");
          document.getElementById("play7sBtn").style.display = "block";
        }
      }, 1000);
    }

    const duelSong = { artist: "Vkie", title: "2025 freestyle", videoId: "TUTAJ_WSTAW_VIDEO_ID" };
    function playDuelSong() {
      playSongLimited(duelSong.videoId, 3);
      if (conn && !isHost) conn.send({ type: 'play' }); // Gość też może odtwarzać dla gospodarza
    }

    function play7sDuelSong() {
      playSongLimited(duelSong.videoId, 7);
      if (conn && !isHost) conn.send({ type: 'play7s' });
    }

    function playSongLimited(videoId, duration) {
      const playerContainer = document.getElementById("playerContainer");
      playerContainer.innerHTML = '<span class="close-player" onclick="closePlayer()">X</span>';
      const iframe = document.createElement("iframe");
      iframe.width = "560";
      iframe.height = "315";
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&start=0&end=${duration}`;
      iframe.allow = "autoplay; encrypted-media";
      playerContainer.appendChild(iframe);
      playerContainer.style.display = "block";
    }

    function checkArtist() {
      const artistInput = document.getElementById("player1Artist").value.trim().toLowerCase();
      const correctArtist = duelSong.artist.toLowerCase();
      if (artistInput === correctArtist) {
        showDuelNotification("Poprawny artysta! Teraz wpisz tytuł.");
        document.getElementById("player1Artist").disabled = true;
        document.getElementById("checkArtistBtn").style.display = "none";
        document.getElementById("player1Title").disabled = false;
        document.getElementById("checkTitleBtn").style.display = "inline-block";
        artistCorrect = true;
      } else {
        showDuelNotification("Zły artysta! Spróbuj jeszcze raz.");
      }
    }

    function checkTitle() {
      const titleInput = document.getElementById("player1Title").value.trim().toLowerCase();
      const correctTitle = duelSong.title.toLowerCase();
      if (titleInput === correctTitle && artistCorrect) {
        const winner = isHost ? lobbyPlayers[0] : lobbyPlayers[1];
        showDuelNotification(`${winner} wygrał!`);
        disableInputs();
        if (conn) conn.send({ type: 'result', message: `${winner} wygrał!` });
      } else {
        showDuelNotification("Zły tytuł! Spróbuj jeszcze raz.");
      }
    }

    function disableInputs() {
      document.getElementById("player1Artist").disabled = true;
      document.getElementById("player1Title").disabled = true;
      document.getElementById("checkArtistBtn").style.display = "none";
      document.getElementById("checkTitleBtn").style.display = "none";
      document.getElementById("playBtn").style.display = "none";
      document.getElementById("play7sBtn").style.display = "none";
    }

    function showDuelNotification(message) {
      const notification = document.getElementById("duelNotification");
      notification.textContent = message;
      notification.style.opacity = "1";
      setTimeout(() => notification.style.opacity = "0", 3000);
    }

    function resetDuel() {
      document.getElementById("duelsGame").style.display = "none";
      document.getElementById("lobbyScreen").style.display = "none";
      document.getElementById("duelsSetup").style.display = "block";
      document.getElementById("playBtn").style.display = "none";
      document.getElementById("play7sBtn").style.display = "none";
      document.getElementById("duelNotification").textContent = "";
      document.getElementById("player1Artist").value = "";
      document.getElementById("player1Title").value = "";
      document.getElementById("player1Artist").disabled = false;
      document.getElementById("player1Title").disabled = true;
      document.getElementById("checkArtistBtn").style.display = "inline-block";
      document.getElementById("checkTitleBtn").style.display = "none";
      closePlayer();
      document.getElementById("sessionCode").style.display = "none";
      document.getElementById("joinCode").style.display = "none";
      lobbyPlayers = [];
      artistCorrect = false;
      if (peer) peer.destroy();
      conn = null;
    }
  </script>
</body>
</html>
